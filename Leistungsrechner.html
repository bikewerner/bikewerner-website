<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Leistungsrechner</title>
</head>
<body>
    <h1>GPX Leistungsrechner</h1>
    <input type="file" id="gpxFile" accept=".gpx">
    <button onclick="processGPX()">Berechnen</button>
    <p id="result"></p>

    <script>
        async function processGPX() {
            const fileInput = document.getElementById('gpxFile');
            if (!fileInput.files.length) {
                alert("Bitte eine GPX-Datei auswählen.");
                return;
            }

            const file = fileInput.files[0];
            const text = await file.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "application/xml");
            
            const points = Array.from(xmlDoc.getElementsByTagName("trkpt"));
            let totalTime = 0;
            let segments = [];

            for (let i = 1; i < points.length; i++) {
                const p1 = points[i - 1];
                const p2 = points[i];
                
                const lat1 = parseFloat(p1.getAttribute("lat"));
                const lon1 = parseFloat(p1.getAttribute("lon"));
                const ele1 = parseFloat(p1.getElementsByTagName("ele")[0]?.textContent || 0);
                const time1 = new Date(p1.getElementsByTagName("time")[0]?.textContent).getTime();
                
                const lat2 = parseFloat(p2.getAttribute("lat"));
                const lon2 = parseFloat(p2.getAttribute("lon"));
                const ele2 = parseFloat(p2.getElementsByTagName("ele")[0]?.textContent || 0);
                const time2 = new Date(p2.getElementsByTagName("time")[0]?.textContent).getTime();
                
                const distance = haversine(lat1, lon1, lat2, lon2);
                const elevationGain = Math.max(0, ele2 - ele1);
                const segmentTime = (time2 - time1) / 1000; // Zeit in Sekunden
                
                totalTime += segmentTime;
                segments.push({ distance, elevationGain, segmentTime });
            }
            
            const avgPower = calculatePower(segments, totalTime);
            document.getElementById("result").innerText = `Durchschnittliche benötigte Leistung: ${avgPower.toFixed(2)} W`;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Erdradius in Metern
            const toRad = Math.PI / 180;
            const dLat = (lat2 - lat1) * toRad;
            const dLon = (lon2 - lon1) * toRad;
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function calculatePower(segments, totalTime) {
            const mass = 90;
            const crr = 0.005;
            const cda = 0.35;
            const drivetrainEfficiency = 0.97;
            const g = 9.81;
            const airDensity = 1.225;
            
            let totalPower = 0;
            
            segments.forEach(({ distance, elevationGain, segmentTime }) => {
                const velocity = segmentTime > 0 ? distance / segmentTime : 0;
                
                const rollingResistance = crr * mass * g * velocity;
                const aerodynamicDrag = 0.5 * airDensity * cda * Math.pow(velocity, 3);
                const gravityForce = distance > 0 ? (mass * g * elevationGain / distance) * velocity : 0;
                
                const power = (rollingResistance + aerodynamicDrag + gravityForce) / drivetrainEfficiency;
                totalPower += power * segmentTime;
            });
            
            return totalTime > 0 ? totalPower / totalTime : 0;
        }
    </script>
</body>
</html>
