<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Leistungsrechner</title>
</head>
<body>
    <h1>GPX Leistungsrechner</h1>
    <input type="file" id="gpxFile" accept=".gpx">
    <button onclick="processGPX()">Berechnen</button>
    <p id="result"></p>

    <script>
        async function processGPX() {
            const fileInput = document.getElementById('gpxFile');
            if (!fileInput.files.length) {
                alert("Bitte eine GPX-Datei auswählen.");
                return;
            }

            const file = fileInput.files[0];
            const text = await file.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "application/xml");
            
            const points = Array.from(xmlDoc.getElementsByTagName("trkpt"));
            let totalTime = 0;
            let totalEnergy = 0;
            
            const mass = 90;
            const crr = 0.005;
            const cda = 0.35;
            const drivetrainEfficiency = 0.97;
            const g = 9.81;
            const airDensity = 1.225;
            
            for (let i = 1; i < points.length; i++) {
                const p1 = points[i - 1];
                const p2 = points[i];
                
                const lat1 = parseFloat(p1.getAttribute("lat"));
                const lon1 = parseFloat(p1.getAttribute("lon"));
                const ele1 = parseFloat(p1.getElementsByTagName("ele")[0]?.textContent || 0);
                const time1 = new Date(p1.getElementsByTagName("time")[0]?.textContent).getTime();
                
                const lat2 = parseFloat(p2.getAttribute("lat"));
                const lon2 = parseFloat(p2.getAttribute("lon"));
                const ele2 = parseFloat(p2.getElementsByTagName("ele")[0]?.textContent || 0);
                const time2 = new Date(p2.getElementsByTagName("time")[0]?.textContent).getTime();
                
                const distance = haversine(lat1, lon1, lat2, lon2);
                const elevationGain = ele2 - ele1;
                const segmentTime = (time2 - time1) / 1000; // Zeit in Sekunden
                
                if (segmentTime > 0 && distance > 0) {
                    totalTime += segmentTime;
                    const velocity = distance / segmentTime;
                    const gradient = elevationGain / distance;
                    
                    const rollingResistance = crr * mass * g * Math.cos(Math.atan(gradient));
                    const aerodynamicDrag = 0.5 * airDensity * cda * velocity * velocity;
                    const gravityForce = mass * g * Math.sin(Math.atan(gradient));
                    
                    const totalForce = (rollingResistance + aerodynamicDrag + gravityForce);
                    const power = (totalForce * velocity) / drivetrainEfficiency;
                    const energy = power * segmentTime;
                    
                    totalEnergy += energy;
                }
            }
            
            const avgPower = totalTime > 0 ? totalEnergy / totalTime : 0;
            document.getElementById("result").innerText = `Durchschnittliche benötigte Leistung: ${avgPower.toFixed(2)} W`;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Erdradius in Metern
            const toRad = Math.PI / 180;
            const dLat = (lat2 - lat1) * toRad;
            const dLon = (lon2 - lon1) * toRad;
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>
</html>
